image:
  name: gitlab.anakeen.com:4567/anakeen/platform-4/docker/build/build:latest

stages:
  - lint
  - buildJS
  - buildHub
  - build
  - test
  - registry
  - release
  - publish
  - tear-down

.default-cache:
  cache: &default-cache
    key: "MonoRepo"
    untracked: true

.pull-cache: &pull-cache
  cache:
    <<: *default-cache
    policy: pull

before_script:
  # install npm deps
  - node .devtool/ci/utils/selectRegistry.js
  - yarn install --frozen-lockfile
  - export ANK_CI_ARTEFACTS_PATH=$(pwd)/build
  - export ANK_CI_BUCKET=$(node ./.devtool/ci/utils/selectBucket.js)
  - export ANK_CI_A4PPM=$(node ./.devtool/ci/utils/selectA4ppm.js)

# region tear-up
populate-cache-master:
  stage: tear-down
  tags:
    - a4ppm
  cache:
    <<: *default-cache
  script:
    #Suppress build part
    - rm -rf ./build/

#endregion tear-up

#region lint
lint-php:
  <<: *pull-cache
  stage: lint
  tags:
    - a4ppm
  script:
    - make lint
  artifacts:
    paths:
      - .devtool/ci/check/checkPHP/
      - smart-data-engine/src/vendor/Anakeen/lib/
      - smart-data-engine/Tests/src/vendor/Anakeen/TestUnits/lib
      - user-interfaces/src/vendor/Anakeen/Ui/PhpLib/
    expire_in: 1 day

lint-js:
  <<: *pull-cache
  stage: lint
  tags:
    - a4ppm
  script:
    - make lint-JS
  artifacts:
    paths:
      - node_modules/
      - .eslintcache
    expire_in: 1 day

lint-po:
  <<: *pull-cache
  stage: lint
  tags:
    - a4ppm
  script:
    - make lint-po
#endregion lint

#region buildJS

user-interfaces-buildJS:
  <<: *pull-cache
  stage: buildJS
  tags:
  - a4ppm
  script:
    - make -C user-interfaces buildDLL
  artifacts:
    paths:
      - user-interfaces/src/public/Anakeen/ankDll/
      - user-interfaces/src/public/Anakeen/assets/
      - user-interfaces/src/public/Anakeen/ank-components/
      - user-interfaces/components/lib/
    expire_in: 1 day
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - user-interfaces/**/*
      - hub-station/**/*
      - admin-center/**/*
      - business-app/**/*
      - development-center/**/*
      - transformation/**/*

internal-components-buildJS:
  <<: *pull-cache
  stage: buildJS
  tags:
  - a4ppm
  script:
    - make -C internal-components app
  artifacts:
    paths:
      - internal-components/lib/
    expire_in: 1 day
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - internal-components/**/*
      - hub-station/**/*
      - admin-center/**/*
      - business-app/**/*
      - development-center/**/*
      - transformation/**/*

hub-station-buildJS:
  <<: *pull-cache
  stage: buildHub
  tags:
  - a4ppm
  script:
    - make -C hub-station buildDLL
  artifacts:
    paths:
      - hub-station/components/lib/
      - hub-station/src/public/Anakeen/hubVendor/
    expire_in: 1 day
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - hub-station/**/*
      - admin-center/**/*
      - business-app/**/*
      - development-center/**/*
      - transformation/**/*

#endregion buildJS

#region build
.build-package:
 <<: *pull-cache
 stage: build
 tags:
  - a4ppm
 script:
   - rm -rf ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME}
   - mkdir -p ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME}
   - make -C ${PACKAGE_PATH} stubs
   - make APP_OUTPUT_PATH=${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME} -C ${PACKAGE_PATH} ${MODE}
   - export ANK_CI_APP_VERSION=$(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME} ${PACKAGE_NAME})
   - tar -C ${PACKAGE_PATH} -czf ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME}/${PACKAGE_NAME}-${ANK_CI_APP_VERSION}.tar.gz ./src ./stubs
 artifacts:
   paths:
     - build/${PACKAGE_NAME}
     - ${PACKAGE_PATH}/node_modules
   expire_in: 1 day

smart-data-engine-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: smart-data-engine
   PACKAGE_NAME: smart-data-engine
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
      - smart-data-engine/**/*

smart-data-engine-integration-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: smart-data-engine
   PACKAGE_NAME: smart-data-engine
   MODE: "app-autorelease"
 only:
   refs:
     - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - smart-data-engine/**/*

security-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: security
   PACKAGE_NAME: security
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - security/**/*

security-integration-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: security
   PACKAGE_NAME: security
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - security/**/*

workflow-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: workflow
   PACKAGE_NAME: workflow
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - workflow/**/*

workflow-integration-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: workflow
   PACKAGE_NAME: workflow
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - workflow/**/*

user-interfaces-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: user-interfaces
   PACKAGE_NAME: user-interfaces
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - user-interfaces/**/*

user-interfaces-integration-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: user-interfaces
   PACKAGE_NAME: user-interfaces
   MODE: "app-autorelease"
 only:
   refs:
    - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - user-interfaces/**/*

hub-station-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: hub-station
   PACKAGE_NAME: anakeen-hub
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - hub-station/**/*

hub-station-integration-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: hub-station
   PACKAGE_NAME: anakeen-hub
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - hub-station/**/*

admin-center-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: admin-center
   PACKAGE_NAME: admin-center
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - admin-center/**/*

admin-center-integration-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: admin-center
   PACKAGE_NAME: admin-center
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - admin-center/**/*

business-app-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: business-app
   PACKAGE_NAME: anakeen-hub-business-app
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - business-app/**/*

business-app-integration-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: business-app
   PACKAGE_NAME: anakeen-hub-business-app
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - business-app/**/*

development-center-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: development-center
   PACKAGE_NAME: development-center
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - development-center/**/*

development-center-integration-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: development-center
   PACKAGE_NAME: development-center
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - development-center/**/*

transformation-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: transformation
   PACKAGE_NAME: transformation
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - transformation/**/*

transformation-integration-build:
 extends: .build-package
 stage: build
 tags:
  - a4ppm
 variables:
   PACKAGE_PATH: transformation
   PACKAGE_NAME: transformation
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - transformation/**/*

migration-tools-build:
  extends: .build-package
  stage: build
  tags:
  - a4ppm
  variables:
    PACKAGE_PATH: migration-tools
    PACKAGE_NAME: migration-tools
    MODE: "app"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - migration-tools/**/*

migration-tools-integration-build:
  extends: .build-package
  stage: build
  tags:
  - a4ppm
  variables:
    PACKAGE_PATH: migration-tools
    PACKAGE_NAME: migration-tools
    MODE: "app-autorelease"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - migration-tools/**/*

#endregion build

#buildControl
control-build:
  <<: *pull-cache
  stage: build
  tags:
    - a4ppm
  variables:
    PACKAGE_PATH: control
  script:
    - export ANK_CI_APP_VERSION=$(jq .version ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME}/version.json)
    - make APP_OUTPUT_PATH=${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME} -C control app
    - tar -C control -czf ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME}/control-${ANK_CI_APP_VERSION}.tar.gz ./src
  artifacts:
    paths:
      - build/${PACKAGE_NAME}
      - ${PACKAGE_PATH}/node_modules
    expire_in: 1 day
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - control/**/*

control-integration-build:
  <<: *pull-cache
  stage: build
  tags:
    - a4ppm
  variables:
    PACKAGE_PATH: control
  script:
    - export ANK_CI_APP_VERSION=$(jq .version ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME}/version.json)
    - make APP_OUTPUT_PATH=${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME} -C control app-autorelease
    - tar -C control -czf ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_NAME}/control-${ANK_CI_APP_VERSION}.tar.gz ./src
  artifacts:
    paths:
      - build/${PACKAGE_NAME}
      - ${PACKAGE_PATH}/node_modules
    expire_in: 1 day
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - control/**/*
#endBuildControl

#region publishNpm
.npm-publish-package:
  <<: *pull-cache
  stage: registry
  tags:
    - a4ppm
  script:
    - npx npm-cli-login -u ${CIBUILD_STABLE_ANAKEEN_NPM_LOGIN} -p ${CIBUILD_STABLE_ANAKEEN_NPM_PASSWORD} -e ${CIBUILD_ANAKEEN_NPM_EMAIL} -r ${CIBUILD_STABLE_ANAKEEN_NPM_REGISTRY} -s "@anakeen"
    - cd ${PACKAGE_PATH} && npm publish

.npm-publish-package-integration:
  <<: *pull-cache
  stage: registry
  tags:
    - a4ppm
  script:
    - npx npm-cli-login -u ${CIBUILD_INTEGRATION_ANAKEEN_NPM_LOGIN} -p ${CIBUILD_INTEGRATION_ANAKEEN_NPM_PASSWORD} -e ${CIBUILD_ANAKEEN_NPM_EMAIL} -r ${CIBUILD_INTEGRATION_ANAKEEN_NPM_REGISTRY} -s "@anakeen"
    - node ./.devtool/ci/utils/autorelease.js ${PACKAGE_PATH} "COMPUTE"
    - cd ${PACKAGE_PATH} && npm publish

.npm-publish-package-integration-synchro:
  <<: *pull-cache
  stage: registry
  tags:
    - a4ppm
  script:
    - npx npm-cli-login -u ${CIBUILD_INTEGRATION_ANAKEEN_NPM_LOGIN} -p ${CIBUILD_INTEGRATION_ANAKEEN_NPM_PASSWORD} -e ${CIBUILD_ANAKEEN_NPM_EMAIL} -r ${CIBUILD_INTEGRATION_ANAKEEN_NPM_REGISTRY} -s "@anakeen"
    - node ./.devtool/ci/utils/autorelease.js ${PACKAGE_PATH} $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/${ANK_CI_APP_NAME} ${ANK_CI_APP_NAME})
    - cd ${PACKAGE_PATH} && npm publish

anakeen-cli-integration-publish:
  extends: .npm-publish-package-integration
  variables:
    PACKAGE_PATH: anakeen-cli
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - anakeen-cli/**/*

anakeen-cli-publish:
  extends: .npm-publish-package
  variables:
    PACKAGE_PATH: anakeen-cli
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - anakeen-cli/**/*

module-validation-integration-publish:
  extends: .npm-publish-package-integration
  variables:
    PACKAGE_PATH: module-validation
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - module-validation/**/*

module-validation-publish:
  extends: .npm-publish-package
  variables:
    PACKAGE_PATH: module-validation
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - module-validation/**/*

theme-variable-integration-publish:
  extends: .npm-publish-package-integration
  variables:
    PACKAGE_PATH: theme-variables
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - theme-variable/**/*

theme-variables-publish:
  extends: .npm-publish-package
  variables:
    PACKAGE_PATH: theme-variables
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - theme-variables/**/*

user-interfaces-integration-publish:
  extends: .npm-publish-package-integration-synchro
  variables:
    PACKAGE_PATH: user-interfaces
    ANK_CI_APP_NAME: user-interfaces
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - user-interfaces/**/*

user-interfaces-publish:
  extends: .npm-publish-package
  variables:
    PACKAGE_PATH: user-interfaces
    ANK_CI_APP_NAME: user-interfaces
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - user-interfaces/**/*

hub-station-integration-publish:
  extends: .npm-publish-package-integration-synchro
  variables:
    PACKAGE_PATH: hub-station
    ANK_CI_APP_NAME: anakeen-hub
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - hub-station/**/*

hub-station-publish:
  extends: .npm-publish-package
  variables:
    PACKAGE_PATH: hub-station
    ANK_CI_APP_NAME: anakeen-hub
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - hub-station/**/*

#endregion publishNpm

#region registry
.registry:
  <<: *pull-cache
  stage: registry
  tags:
    - a4ppm
  script:
    - export ANK_CI_APP_VERSION=$(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/${ANK_CI_APP_NAME} ${ANK_CI_APP_NAME})
    - >-
      curl -f
      --header "X-Http-Method-Override: PUT"
      -F name=${ANK_CI_APP_NAME}
      -F version=${ANK_CI_APP_VERSION}
      -F metadata="{
        \"git-sha\": \"${CI_COMMIT_SHA}\",
        \"git-ref\": \"${CI_COMMIT_REF}\",
        \"version\": \"${ANK_CI_APP_VERSION}\",
        \"release\": \"\",
        \"date\": \"$(date '+%Y-%m-%d %H-%M-%S')\",
        \"author\": \"${GITLAB_USER_NAME}\"
      }"
      -F app=@${ANK_CI_ARTEFACTS_PATH}/${ANK_CI_APP_NAME}/${ANK_CI_APP_NAME}-${ANK_CI_APP_VERSION}.app
      -F src=@${ANK_CI_ARTEFACTS_PATH}/${ANK_CI_APP_NAME}/${ANK_CI_APP_NAME}-${ANK_CI_APP_VERSION}.tar.gz
      --request POST
      "${ANK_CI_A4PPM}/${ANK_CI_BUCKET}"

smart-data-engine-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "smart-data-engine"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - smart-data-engine/**/*

smart-data-engine-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "smart-data-engine"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - smart-data-engine/**/*

workflow-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "workflow"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - workflow/**/*

workflow-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "workflow"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - workflow/**/*

security-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "security"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - security/**/*

security-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "security"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - security/**/*

user-interfaces-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "user-interfaces"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - user-interfaces/**/*

user-interfaces-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "user-interfaces"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - user-interfaces/**/*

migration-tools-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "migration-tools"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - migration-tools/**/*

migration-tools-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "migration-tools"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - migration-tools/**/*

hub-station-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "anakeen-hub"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - hub-station/**/*

hub-station-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "anakeen-hub"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - hub-station/**/*

business-app-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "anakeen-hub-business-app"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - business-app/**/*

business-app-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "anakeen-hub-business-app"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - business-app/**/*

development-center-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "development-center"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - development-center/**/*

development-center-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "development-center"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - development-center/**/*

admin-center-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "admin-center"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - admin-center/**/*

admin-center-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "admin-center"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - admin-center/**/*

transformation-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "transformation"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - transformation/**/*

transformation-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "transformation"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - transformation/**/*

#endregion registry

#region registryControl
.registry-control:
  <<: *pull-cache
  stage: registry
  tags:
    - a4ppm
  script:
    - export ANK_CI_APP_VERSION=$(jq .version ${ANK_CI_ARTEFACTS_PATH}/${ANK_CI_APP_NAME}/version.json)
    - >-
      curl -f
      --header "X-Http-Method-Override: PUT"
      -F name=${ANK_CI_APP_NAME}
      -F version=${ANK_CI_APP_VERSION}
      -F metadata="{
        \"git-sha\": \"${CI_COMMIT_SHA}\",
        \"git-ref\": \"${CI_COMMIT_REF}\",
        \"version\": \"${ANK_CI_APP_VERSION}\",
        \"release\": \"\",
        \"date\": \"$(date '+%Y-%m-%d %H-%M-%S')\",
        \"author\": \"${GITLAB_USER_NAME}\"
      }"
      -F app=@${ANK_CI_ARTEFACTS_PATH}/${ANK_CI_APP_NAME}/${ANK_CI_APP_NAME}-${ANK_CI_APP_VERSION}.app
      -F src=@${ANK_CI_ARTEFACTS_PATH}/${ANK_CI_APP_NAME}/${ANK_CI_APP_NAME}-${ANK_CI_APP_VERSION}.tar.gz
      --request POST
      "${ANK_CI_A4PPM}/${ANK_CI_BUCKET}"

control-register:
  extends: .registry-control
  variables:
    ANK_CI_APP_NAME: "control"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - control/**/*

control-integration-register:
  extends: .registry-control
  variables:
    ANK_CI_APP_NAME: "control"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - control/**/*

#endregion registryControl