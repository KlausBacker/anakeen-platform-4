image:
  name: gitlab.anakeen.com:4567/anakeen/platform-4/docker/build/build:latest

stages:
  - tear-up
  - lint
  - buildJS
  - buildHub
  - build
  - test
  - registry
  - release
  - publish

.default-cache:
  cache: &default-cache
    key: "Anakeen:MonoRepo"
    paths:
      - node_modules
      - .devtool/ci/check/checkPHP/vendor
      - smart-data-engine/src/vendor/Anakeen/lib/vendor
      - smart-data-engine/Tests/src/vendor/Anakeen/TestUnits/lib
      - user-interfaces/src/vendor/Anakeen/Ui/PhpLib/
      - user-interfaces/src/vendor/Anakeen/lib/
      - user-interfaces/Tests/src/vendor/Anakeen/TestUnits/lib
      - .eslintcache
      - build

.pull-cache: &pull-cache
  cache:
    <<: *default-cache
    policy: pull

before_script:
  # install npm deps
  - node .devtool/ci/utils/selectRegistry.js
    # init tmp workdir
  - yarn install --frozen-lockfile
  - composer install --working-dir=./.devtool/ci/check/checkPHP/ --ignore-platform-reqs
  - composer install --working-dir=./smart-data-engine/src/vendor/Anakeen/lib/
  - composer install --working-dir=./smart-data-engine/Tests/src/vendor/Anakeen/TestUnits/lib
  - composer install --working-dir=./user-interfaces/src/vendor/Anakeen/Ui/PhpLib/
  - export ANK_CI_ARTEFACTS_PATH=./build
  - export ANK_CI_BUCKET=$(node ./.devtool/ci/utils/selectBucket.js)
  - export ANK_CI_A4PPM=$(node ./.devtool/ci/utils/selectA4ppm.js)

# region tear-up
populate-cache-master:
  stage: tear-up
  cache:
    <<: *default-cache
  script:
    - yarn install --frozen-lockfile
    - composer install --working-dir=./.devtool/ci/check/checkPHP/ --ignore-platform-reqs
    - composer install --working-dir=./smart-data-engine/src/vendor/Anakeen/lib/
    - composer install --working-dir=./smart-data-engine/Tests/src/vendor/Anakeen/TestUnits/lib
    - composer install --working-dir=./user-interfaces/src/vendor/Anakeen/Ui/PhpLib/
  only:
    - master
    - web
#endregion tear-up

#region lint
lint-php:
  <<: *pull-cache
  stage: lint
  script:
    - make lint
  only:
    - merge_requests
    - web

lint-js:
  cache:
    <<: *default-cache
  stage: lint
  script:
    - make lintJS
  only:
    - merge_requests
    - web
#endregion lint

#region buildJS

user-interfaces-buildJS:
  cache:
    <<: *default-cache
  stage: buildJS
  script:
    - make -C user-interfaces buildDLL
  artifacts:
    paths:
      - user-interfaces/src/public/Anakeen/ankDll/
      - user-interfaces/src/public/Anakeen/assets/
      - user-interfaces/src/public/Anakeen/ank-components/
      - user-interfaces/components/lib/
    expire_in: 1 hour
  only:
    changes:
      - user-interfaces

internal-components-buildJS:
  cache:
    <<: *default-cache
  stage: buildJS
  script:
    - make -C internal-components app
  artifacts:
    paths:
      - internal-components/lib/
    expire_in: 1 hour
  only:
    changes:
      - internal-components

hub-station-buildJS:
  cache:
    <<: *default-cache
  stage: buildHub
  script:
    - make -C hub-station buildDLL
  artifacts:
    paths:
      - hub-station/components/lib/
      - hub-station/src/public/Anakeen/hubVendor/
    expire_in: 1 hour
  only:
    changes:
      - hub-station
  dependencies:
    - user-interfaces-buildJS
    - internal-components-buildJS

#endregion buildJS

#region build
.build-package:
 <<: *pull-cache
 stage: build
 script:
   - mkdir -p ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_PATH}
   - make -C ${PACKAGE_PATH} stubs
   - make APP_OUTPUT_PATH=${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_PATH} -C ${PACKAGE_PATH} ${MODE}
   - export ANK_CI_APP_VERSION=$(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_PATH} ${PACKAGE_PATH})
   - tar -C ${PACKAGE_PATH} -czf ${ANK_CI_ARTEFACTS_PATH}/${PACKAGE_PATH}/${PACKAGE_PATH}-${ANK_CI_APP_VERSION}.tar.gz ./src ./stubs

smart-data-engine-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: smart-data-engine
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
      - smart-data-engine

smart-data-engine-integration-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: smart-data-engine
   MODE: "app-autorelease"
 only:
   refs:
     - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - smart-data-engine

security-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: security
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - security

security-integration-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: security
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - security

workflow-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: workflow
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - workflow

workflow-integration-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: workflow
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - workflow

user-interfaces-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: user-interfaces
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - user-interfaces

user-interfaces-integration-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: user-interfaces
   MODE: "app-autorelease"
 only:
   refs:
    - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - user-interfaces

hub-station-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: hub-station
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - hub-station
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS

hub-station-integration-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: hub-station
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - hub-station
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS

admin-center-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: admin-center
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - admin-center
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS
   - hub-station-buildJS

admin-center-integration-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: admin-center
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - admin-center
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS
   - hub-station-buildJS

business-app-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: business-app
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - business-app
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS
   - hub-station-buildJS

business-app-integration-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: business-app
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - business-app
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS
   - hub-station-buildJS

development-center-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: development-center
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - development-center
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS
   - hub-station-buildJS

development-center-integration-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: development-center
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - development-center
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS
   - hub-station-buildJS

transformation-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: transformation
   MODE: "app"
 only:
   refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - transformation
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS
   - hub-station-buildJS

transformation-integration-build:
 extends: .build-package
 stage: build
 variables:
   PACKAGE_PATH: transformation
   MODE: "app-autorelease"
 only:
   refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
   changes:
     - transformation
 dependencies:
   - user-interfaces-buildJS
   - internal-components-buildJS
   - hub-station-buildJS

migration-tools-build:
  extends: .build-package
  stage: build
  variables:
    PACKAGE_PATH: migration-tools
    MODE: "app"
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - migration-tools

migration-tools-integration-build:
  extends: .build-package
  stage: build
  variables:
    PACKAGE_PATH: migration-tools
    MODE: "app-autorelease"
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - migration-tools

#endregion build

#region publishNpm
.npm-publish-package:
  <<: *pull-cache
  stage: registry
  script:
    - cd ${PACKAGE_PATH} && npm publish

anakeen-cli-integration-publish:
  extends: .npm-publish-package
  before_script:
    -  node ./.devtool/ci/utils/autorelease.js ./anakeen-cli
  variables:
    PACKAGE_PATH: anakeen-cli
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - anakeen-cli

anakeen-cli-publish:
  extends: .npm-publish-package
  variables:
    PACKAGE_PATH: anakeen-cli
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - anakeen-cli

module-validation-integration-publish:
  extends: .npm-publish-package
  before_script:
    -  node ./.devtool/ci/utils/autorelease.js ./module-validation
  variables:
    PACKAGE_PATH: module-validation
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - module-validation

module-validation-publish:
  extends: .npm-publish-package
  variables:
    PACKAGE_PATH: module-validation
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - module-validation

theme-variable-integration-publish:
  extends: .npm-publish-package
  before_script:
    -  node ./.devtool/ci/utils/autorelease.js ./theme-variable
  variables:
    PACKAGE_PATH: theme-variable
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - theme-variable

theme-variable-publish:
  extends: .npm-publish-package
  variables:
    PACKAGE_PATH: theme-variable
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - theme-variable

#endregion publishNpm

#region registry
.registry:
  <<: *pull-cache
  stage: registry
  script:
    - >-
      curl -f
      --header "X-Http-Method-Override: PUT"
      -F name=${ANK_CI_APP_NAME}
      -F version=${ANK_CI_APP_VERSION}
      -F metadata="{
        \"git-sha\": \"${CI_COMMIT_SHA}\",
        \"git-ref\": \"${CI_COMMIT_REF}\",
        \"version\": \"${ANK_CI_APP_VERSION}\",
        \"release\": \"\",
        \"date\": \"$(date '+%Y-%m-%d %H-%M-%S')\",
        \"author\": \"${GITLAB_USER_NAME}\"
      }"
      -F app=@${ANK_CI_ARTEFACTS_PATH}/${ANK_CI_APP_NAME}-${ANK_CI_APP_VERSION}.app
      -F src=@${ANK_CI_ARTEFACTS_PATH}/${ANK_CI_APP_NAME}-${ANK_CI_APP_VERSION}.tar.gz
      --request POST
      "${ANK_CI_A4PPM}/${ANK_CI_BUCKET}"

smart-data-engine-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "smart-data-engine"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/smart-data-engine smart-data-engine)
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - smart-data-engine

smart-data-engine-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "smart-data-engine"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/smart-data-engine smart-data-engine)
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - smart-data-engine

workflow-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "workflow"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/workflow workflow)
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - workflow

workflow-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "workflow"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/workflow workflow)
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - workflow

security-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "security"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/security security)
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - security

security-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "security"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/security security)
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - security

user-interfaces-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "user-interfaces"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/user-interfaces user-interfaces)
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - user-interfaces

user-interfaces-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "user-interfaces"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/user-interfaces user-interfaces)
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - user-interfaces

migration-tools-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "migration-tools"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/migration-tools migration-tools)
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - migration-tools

migration-tools-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "migration-tools"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/migration-tools migration-tools)
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - migration-tools

hub-station-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "hub-station"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/hub-station hub-station)
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - hub-station

hub-station-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "hub-station"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/hub-station hub-station)
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - hub-station

business-app-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "business-app"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/business-app business-app)
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - business-app

business-app-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "business-app"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/business-app business-app)
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - business-app

development-center-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "development-center"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/development-center development-center)
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - development-center

development-center-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "development-center"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/development-center development-center)
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - development-center

transformation-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "transformation"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/transformation transformation)
  only:
    refs:
      - /^\d+\.\d+-stable$/@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - transformation

transformation-integration-register:
  extends: .registry
  variables:
    ANK_CI_APP_NAME: "transformation"
    ANK_CI_APP_VERSION: $(node ./.devtool/ci/utils/getVersionFromApp.js ${ANK_CI_ARTEFACTS_PATH}/transformation transformation)
  only:
    refs:
      - master@Anakeen/Platform-4/anakeen-platform-4
    changes:
      - transformation