<?php
namespace Anakeen\Components\Grid\Routes;

use Anakeen\Core\Utils\FileMime;
use Anakeen\Router\ApiV2Response;
use Anakeen\Router\Exception;

require_once "vendor/Anakeen/Ui/PhpLib/vendor/autoload.php";

use Anakeen\Routes\Ui\Transaction\TransactionManager;
use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Style\NumberFormat;
use PhpOffice\PhpSpreadsheet\Worksheet\Worksheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

/**
 * Class GridExport
 * @package Anakeen\Components\Grid\Routes
 * @note use by route /api/v2/grid/export/{collectionId}
 */
class GridExport extends GridContent {

    protected $clientColumnsConfig = [];
    protected $selectedRows = [];
    protected $unselectedRows = [];
    protected $transaction = null;
    protected $transactionId = null;

    public function __invoke(\Slim\Http\request $request, \Slim\Http\response $response, $args)
    {
        $method = $request->getMethod();
        switch ($method) {
            case "GET":
                parent::__invoke($request, $response, $args);
                $transactionId = $args["transactionId"];
                if (empty($transactionId)) {
                    $exception = new Exception("TRANS0002");
                    $exception->setHttpStatus("400", "Transaction id missing");
                    throw $exception;
                }
                return TransactionManager::runTransaction($transactionId, function ($tId) use ($request, $response, $args) {
                    $this->transactionId = $tId;
                    return $this->doExport($request, $response, $args);
                });
            case "POST":
                $this->transaction = TransactionManager::createTransaction();
                return ApiV2Response::withData($response, $this->transaction->getData());
        }
    }

    protected function doExport(\Slim\Http\request $request, \Slim\Http\response $response, $args) {
        $this->clientColumnsConfig = $request->getQueryParam("columnsConfig", []);
        $this->selectedRows = $request->getQueryParam("selectedRows", []);
        $this->unselectedRows = $request->getQueryParam("unselectedRows", []);

        $data = $this->getData();
        $spreadSheet = new Spreadsheet();
        $sheet = $spreadSheet->getActiveSheet();

        $this->writeHeaders($sheet);
        $this->writeValues($sheet, $data["smartElements"]);
        $this->writeFile($spreadSheet);

        return self::withFile($response, "./export.xlsx", "export.xlsx");
    }

    protected function prepareFiltering()
    {
        parent::prepareFiltering(); // TODO: Change the autogenerated stub
        if (!empty($this->selectedRows) && count($this->selectedRows) > 0) {
            $this->_searchDoc->addFilter("id in (%s)", implode(",", $this->selectedRows));
        }
        if (!empty($this->unselectedRows) && count($this->unselectedRows) > 0) {
            $this->_searchDoc->addFilter("id not in (%s)", implode(",", $this->unselectedRows));
        }
    }

    private function writeHeaders(Worksheet $sheet) {
        $styleArray = [
            'font' => [
                'bold' => true,
            ],
            'alignment' => [
                'horizontal' => \PhpOffice\PhpSpreadsheet\Style\Alignment::HORIZONTAL_CENTER,
            ],
            'fill' => [
                'fillType' => \PhpOffice\PhpSpreadsheet\Style\Fill::FILL_PATTERN_DARKGRAY,
            ],
        ];

        $column = "A";
        for ($i = 0; $i < count($this->returnFields); $i++) {
            $sheet->getStyle($column."1")->applyFromArray($styleArray);
            $sheet->getColumnDimension($column++)->setAutoSize('true');
        }

        $columnsNames = array_map(function ($config) {
            return $config["title"];
        }, $this->clientColumnsConfig);

        $sheet->fromArray($columnsNames, NULL, "A1");
    }

    private function getFieldConfig($fieldId) {
        if (!empty($this->clientColumnsConfig)) {
            $fieldConfig = array_filter($this->clientColumnsConfig, function ($config) use ($fieldId) {
                return $config["field"] === $fieldId;
            });
        }
        if (!empty($fieldConfig) && count($fieldConfig) > 0) {
            return array_shift($fieldConfig);
        }
        return null;
    }

    private function writeValues(Worksheet $sheet, $values) {
        $rowIndex = 2;
        $defaultHeight = 20.0;
        $totalValues = count($values);
        $modulo = intval($totalValues/100) || 1;
        \PhpOffice\PhpSpreadsheet\Cell\Cell::setValueBinder( new \PhpOffice\PhpSpreadsheet\Cell\AdvancedValueBinder() );
        TransactionManager::updateProgression($this->transactionId, [
            "exportedRows" => 0,
            "totalRows" => $totalValues
        ]);
        foreach ($values as $datum) {
            $maxHeightCoeff = 1;
            $row = [];
            $columnIndex = "A";
            foreach ($this->returnFields as $field) {
                $tokens = explode(".", $field);
                $fieldType = $tokens[1];
                $fieldId = $tokens[2];
                $fieldConfig = $this->getFieldConfig($fieldId);
                if ($fieldType === "attributes") {
                    if (is_object($datum[$fieldType][$fieldId])) {
                        $row[] = $this->getCellFieldValue($datum[$fieldType][$fieldId], $fieldConfig);
                    } else if (is_array($datum[$fieldType][$fieldId])) {
                        if (count($datum[$fieldType][$fieldId]) > $maxHeightCoeff) {
                            $maxHeightCoeff = count($datum[$fieldType][$fieldId]);
                        }
                        $row[] = implode("\n", array_map(function ($item) use ($fieldConfig) {
                            return $this->getCellFieldValue($item, $fieldConfig);
                        },$datum[$fieldType][$fieldId]));
                    }
                } else {
                    $row[] = $this->getCellPropertyValue($datum[$fieldType][$fieldId], $fieldId);
                }
                $this->setCellFormat(
                    $sheet,
                    $columnIndex.$rowIndex,
                    $fieldConfig["smartType"]
                );
                $columnIndex++;
            }
            $sheet->getRowDimension($rowIndex)->setRowHeight(($maxHeightCoeff * $defaultHeight));
            $sheet->fromArray($row, NULL, "A".$rowIndex++);

            if (($rowIndex - 2) % $modulo === 0) {
                TransactionManager::updateProgression($this->transactionId, [
                    "exportedRows" => $rowIndex - 2,
                    "totalRows" => $totalValues
                ]);
            }
        }
    }

    private function getCellPropertyValue($data, $propId) {
        if (is_array($data)) {
            switch ($propId) {
                case "cdate":
                case "mdate":
                    return $data["value"];
                default:
                    return $data["displayValue"];
            }
        }
        return $data;
    }

    private function getCellFieldValue($data, $dataConfig) {
        switch ($dataConfig["smartType"]) {
            case "date":
            case "int":
            case "double":
            case "money":
                return $data->value;
                break;
            default:
                return $data->displayValue;
        }
    }

    private function setCellFormat(Worksheet $sheet, $cellCoordinate, $format) {
        switch ($format) {
            case "date":
                $sheet->getStyle($cellCoordinate)->getNumberFormat()->setFormatCode(NumberFormat::FORMAT_DATE_YYYYMMDDSLASH);
                break;
            case "int":
            case "double":
            case "money":
                break;
        }
    }

    private function writeFile(Spreadsheet $spreadsheet) {
        $writer = new Xlsx($spreadsheet);
        $writer->save('export.xlsx');
    }

    private static function withFile(
        \Slim\Http\response $response,
        $filePath,
        $fileName = "",
        $mime = ""
    ) {
        if (!$fileName) {
            $fileName = basename($filePath);
        }
        if (!file_exists($filePath)) {
            throw new Exception("GRID0003", basename($filePath));
        }
        if (!$mime) {
            $mime = FileMime::getSysMimeFile(realpath($filePath), $fileName);
        }

        if ($mime) {
            $response = $response->withHeader("Content-type", $mime);
        }

        return $response->write(file_get_contents($filePath));
    }


}