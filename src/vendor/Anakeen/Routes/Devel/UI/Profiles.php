<?php

namespace Anakeen\Routes\Devel\UI;

use Anakeen\Components\Grid\Routes\GridContent;
use Anakeen\Core\Internal\SmartElement;
use Anakeen\Core\SEManager;
use SearchDoc;


/**
 * Get Profiles
 *
 * @note Used by route : GET api/v2/devel/security/profiles/
 */
class Profiles extends GridContent
{

    protected function parseUrlArgs($urlArgs = array())
    {
        $this->smartElementId = 0;
    }

    protected function prepareSearchDoc()
    {
        $this->_searchDoc = new SearchDoc();
        $this->_searchDoc->setObjectReturn();
        $this->_searchDoc->excludeConfidential(true);
    }

    protected function prepareFiltering()
    {
        parent::prepareFiltering(); // TODO: Change the autogenerated stub
        $this->_searchDoc->addFilter("profid = id and (dprofid is null or dprofid = 0)");
    }

    protected function prepareDocumentFormatter($documentList)
    {
        $formatter = parent::prepareDocumentFormatter($documentList); // TODO: Change the autogenerated stub
        $formatter->getFormatCollection()->setDocumentRenderHook(function ($info, SmartElement $doc) {
            error_log(print_r($info, true));
            $famid = $doc->getRawValue("dpdoc_famid");
            if ($famid) {
                $info["attributes"]["dpdoc_famid"]->name = SEManager::getNameFromId($famid);
            }
            return $info;
        });
        $formatter->getFormatCollection()->addAttribute("dpdoc_famid");
        $formatter->addProperty("family");
        return $formatter;
    }


}
